## FIB2.0分层协议
### 预备知识(Prerequisites)

本节描述一些FIB架构基础的先决条件和术语解释
#### 图(Graphs)
FIB本质上是相关图的集合。维基百科上的推论术语通常用于接下来的章节：

_...图表示一组对象的集合，对象之间建立了连接。相互连接的对象在数学上被抽象的叫做顶点(或节点、点)，顶点之间的连接叫做边(或弧、线)，边可以是有向的或者无向的..._

在有向图中，边只能朝一个方向遍历-从子节点到父节点，选择名称以表示多对一的关系。一个子节点有一个父节点，但一个父节点可以有多个子节点。在无向图中，遍历可以从任一方向开始，但在FIB中，父子命令法仍代表了多对一的关系。具有相同父节点的子节点称之为兄弟节点。如果遍历是从子节点到父节点，则被视为向前遍历(Forward Traversal)或步进(Walk)，而从父节点到子节点的遍历被视为向后遍历(Back Walk)。向前遍历成本很小，因为它是从多少少，而从少到多成本就很高。

子节点与父节点之间的多对一关系意味着父节点的生存期必须延长到其子节点的生存期。 如果控制平面在其子节点之前删除了父节点，则父节点必须保持不完整状态，直到子节点本身被删除为止。 同样，如果在其父节点之前创建了一个子节点，则父节点会以未完成状态完成。 需要这些不完整的对象来维护图依赖性。 如果没有它们，则在添加父节点时发现受影响的子节点将通过许多数据库搜索这些子节点。 为了延长父节点的寿命，其所有子节点必须锁定父节点。 这是一个简单的参考计数。 然后，子节点遵循添加或锁定/解锁语义来查找父节点，而不是malloc/free。

#### 前缀(Prefixs)
一些描述前缀的术语:
* 1.1.1.1 这是一个地址,因为没有与它相关联的掩码
* 1.1.1.0/24 这是一个前缀
* 1.1.1.1/32 这是一个主机前缀(掩码长度是地址的长度)

如果前缀A的掩码长度比前缀B的掩码长度长，则前缀A更具体；反之，前缀越短则越不具体，例如: 1.1.1.0/28比1.1.1.0/24更具体。

一个不具体的前缀覆盖范围包括具体的前缀覆盖范围，称之为覆盖前缀(Covering Prefix)，例如: 1.1.1.0/24覆盖1.1.1.0/28，1.1.1.0/28称之为被覆盖前缀(Covered Prefix)，因此，覆盖前缀一定比被覆盖前缀更不具体。

### 数据模型(The Data Model)
FIB数据模型包括两个部分：控制平面(CP)和数据平面(DP)。控制平面数据模型表示由上层编程到VPP中的数据。数据平面模型表示VPP如何在交换数据包时派生对数据包执行的操作。
#### 控制平面(The Control Plane)
控制平面遵循分层数据表示。本文档介绍了从最低层开始的模型。该描述使用IPv4地址和协议，但是所有概念均等同地适用于IPv6。这些图都描绘了用于在VPP中安装信息的CLI命令以及用于表示该信息的数据结构的UML图的近似图。

* ARP条目(ARP Entries)

  ![ARP数据模型](https://github.com/penybai/vpp-docs/blob/master/images/arp-entries.png)
  图1：ARP数据模型

  图1显示了ARP条目的数据模型。ARP条目包含由IPv4地址标识的对等方(peer)与其给定接口上的MAC地址之间的映射。接口绑定的VRF，不是数据的一部分。VRF是入口函数，而不是出口。ARP条目描述了如何向对等方发送流量，这是一种出口功能。

  arp_entry_t表示在控制平面上添加的ARP条目。ip_adjacency_t包含从arp_entry_t派生的数据，这些数据是将数据包转发到对等方所需要的。邻接中的其他数据是rewrite和link_type。link_type是需要邻居转发的数据包中的协议描述，可以是IPv4或MPLS。link_type直接映射到以太网头中的以太类型，或GRE头中归档的协议。rewrite是报头的字节字符串表示形式，当发送到该对等方时，该报头将附加在该数据包之前。对于以太网接口，这将是src、dst MAC和ether-type。对于LISP隧道，使用IP src、dst对和LISP头。

  创建条目时，arp_entry_t将安装link_type = IPv4，而当接口启用MPLS时将安装link_type = MPLS。出于安全原因，必须为接口明确启用MPLS。

  这样就可以在路由之间共享邻接关系，将邻接关系存储在一个数据库中，该数据库的关键字为{interface，next-hop，link-type}。

* 路由(Routes)

  控制平面将通过路径列表在表中为前缀安装路由。FIB的主要功能是解决该路由。解决一条路线就是构造一个对象图，该图完全描述路线的所有元素。在图3中，解决了从fib_entry_t到ip_adjacency_t的图的完整过程。

  在某些路由模型中，VRF将由一组用于IPv4和IPv6以及单播和多播的表组成。在VPP中，没有这样的分组。每个表彼此不同。表格由其数字ID标识。每个地址系列的ID范围都是独立的。

  一个表由两个路由数据库组成，转发和非转发。转发数据库包含路由，数据包将针对这些路由执行数据平面中的最长前缀匹配(LPM)。非转发数据库包含已使用VPP编程的所有路由，其中​​某些路由可能由于无法阻止其插入转发数据库的原因而无法解析(请参阅：[邻接源FIB条目]())。

  路由数据被分解为三部分：条目(entry)、路径列表(path-list)和路径(paths)：

  - FIB源(FIB sources)
  - 邻接源FIB条目(Adjacency source FIB entries)
  - 递归路由(Recursive Routes)
  - 输出标签(Output Labels)
* 连接导出(Attached Export)
* 图遍历(Graph Walks)

#### 数据平面(The Data Plane)